<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            /* overflow: hidden; */
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body>
    <iframe id="contentFrame" src="{{ visor_url }}" allowfullscreen></iframe>
    
    <script src="scorm_wrapper.js"></script>

    <script>
        var scorm = pipwerks.SCORM; 
        var lmsConnected = scorm.init();
        var iframe = document.getElementById('contentFrame');

        if(lmsConnected) console.log("✅ SCORM Conectado (" + scorm.version + ")");
        else console.warn("⚠️ Modo Offline (Sin LMS)");

        window.addEventListener("message", function (event) {
            var data = event.data;

            // --- ESCRIBIR DATOS (COMMIT) ---
            if (data.type === "LMS_COMMIT") {
                if (lmsConnected && data.payload) {
                    var success = true;

                    // 1. Nota (Score)
                    if (data.payload.score !== undefined) 
                        success = scorm.set("cmi.core.score.raw", data.payload.score) && success;
                    
                    // 2. Estado (Status)
                    if (data.payload.status) 
                        success = scorm.set("cmi.core.lesson_status", data.payload.status) && success;

                    // 3. Bookmark (NUEVO: Importante para diapositivas)
                    if (data.payload.bookmark) {
                        success = scorm.set("cmi.core.lesson_location", data.payload.bookmark) && success;
                    }
                    
                    // 4. Datos Extra (Suspend Data)
                    if (data.payload.suspend_data) {
                        var dataString = JSON.stringify(data.payload.suspend_data);
                        success = scorm.set("cmi.suspend_data", dataString) && success;
                    }

                    if(success) scorm.save();
                }
            } 
            
            // --- LEER DATOS (GET) ---
            else if (data.type === "LMS_GET_DATA") {
                if (lmsConnected) {
                    var learnerName = scorm.get("cmi.core.student_name");
                    var status = scorm.get("cmi.core.lesson_status");
                    var bookmark = scorm.get("cmi.core.lesson_location"); // Leemos dónde se quedó
                    var rawSuspendData = scorm.get("cmi.suspend_data");
                    
                    var parsedSuspendData = null;
                    try {
                        if (rawSuspendData) parsedSuspendData = JSON.parse(rawSuspendData);
                    } catch (e) {}

                    iframe.contentWindow.postMessage({
                        type: "LMS_DATA_RECEIVED",
                        payload: {
                            learner_name: learnerName,
                            status: status,
                            bookmark: bookmark, // Enviamos "slide_X" a React
                            suspend_data: parsedSuspendData
                        }
                    }, "*");
                }
            }
        });

        window.onunload = function () { scorm.quit(); };
    </script>

</body>

</html>