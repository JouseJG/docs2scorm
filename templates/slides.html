<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }}</title>

<style>
html, body {
    margin: 0;
    /* padding: 40px 20px 40px 0 !important; */
    padding: 0;
    user-select: none; /* Desactiva la selección de texto */
    /* height: 100%; */
    /* height: 100vh;
    width: 100vw; */
    height: 100%;
    width: 100%;
    
    overflow: hidden; /* ✨ SIN SCROLL */
}

.slide-wrapper {
    /* height: 100vh;
    width: 100vw; */
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: #ffffff;
    overflow: hidden;
}

.slide-content {
    flex: 1;  /* ocupa todo */
    padding: 32px 48px;
    overflow: hidden;
    display: flex;
    justify-content: stretch; /* center;*/
    align-items: center;
    box-sizing: border-box; /**/
}

.slide-inner {
    /* width: 100%;
    max-width: 1000px;
    height: auto; */

    /* max-width: 1000px;
    max-height: calc(100vh - 120px); /* navbar + padding 
    overflow: hidden; */

    width: 100%;
    max-width: 1100px;   /* óptimo para LMS */
    margin: 0 auto;
    overflow: hidden;
}

.navbar {
    height: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f0f0f0;
    padding: 10px 20px;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    margin-bottom: 5rem; 
}

.nav-btn {
    padding: 10px 18px;
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: default;
}

img { max-width: 100%; height: auto; }
</style>

<!-- css original del doc -->
{% if extra_css %}
        {{ extra_css | safe }}
{% endif %}
</head>

<body>
<div class="slide-wrapper">

    <div class="slide-content">
        <div class="slide-inner">
            {{ content | safe }}
        </div>
    </div>

    <!-- NAV BAR -->
    <div class="navbar">
        <button class="nav-btn" id="btnPrev" {% if not prev %} disabled {% endif %}>Anterior</button>
        <button class="nav-btn" id="btnNext" {% if not next %} disabled {% endif %}>Siguiente</button>
    </div>

</div>

<script>
    // ==========================================
    // UTILIDADES SCORM (SCORM WRAPPER SIMPLE)
    // ==========================================
    var SCORM_API = null;

    function findAPI(win) {
        // Busca la API en la ventana actual y sube por la jerarquía de frames
        var findAPITries = 0;
        while ((win.API == null) && (win.parent != null) && (win.parent != win)) {
            findAPITries++;
            if (findAPITries > 7) return null;
            win = win.parent;
        }
        return win.API;
    }

    function getAPI() {
        var theAPI = findAPI(window);
        if ((theAPI == null) && (window.opener != null) && (typeof(window.opener) != "undefined")) {
            theAPI = findAPI(window.opener);
        }
        if (theAPI == null) {
            console.warn("SCORM API no encontrada via window, parent o opener.");
        }
        return theAPI;
    }

    function initSCORM() {
        SCORM_API = getAPI();
        if (SCORM_API) {
            SCORM_API.LMSInitialize("");
            
            // Verificamos estado actual. Si no está completado, lo ponemos en "incomplete"
            var status = SCORM_API.LMSGetValue("cmi.core.lesson_status");
            if (status !== "completed" && status !== "passed") {
                SCORM_API.LMSSetValue("cmi.core.lesson_status", "incomplete");
                SCORM_API.LMSCommit("");
            }   
        }
    }

    function finishSCORM(status) {
        if (SCORM_API) {
            if (status) {
                SCORM_API.LMSSetValue("cmi.core.lesson_status", status);
            }
            SCORM_API.LMSCommit(""); // Guardar datos
            SCORM_API.LMSFinish(""); // Cerrar conexión "colgar teléfono"
        }
    }

    // ==========================================
    // LOGICA DE SLIDES
    // ==========================================
    document.addEventListener("DOMContentLoaded", () => {
        // 1. INICIALIZAR SCORM AL CARGAR
        initSCORM();

        const container = document.querySelector(".slide-inner");
        const rawHTML = container.innerHTML;

        const temp = document.createElement("div");
        temp.innerHTML = rawHTML;

        const children = [...temp.children];
        const joined = [];   // hijos con correcciones de cohesión
    
        function shouldGroup(elem, next) {
            if (!next) return false;
    
            // 1. Heading nunca debe quedar solo
            if (/^H[1-6]$/.test(elem.tagName)) return true;
    
            // 2. Listas completas
            if (elem.tagName === "LI") return true;
    
            // 3. Tablas completas
            if (elem.tagName === "TABLE") return true;
    
            // 4. Si el siguiente es un LI y este NO es un UL/OL, lo agrupamos
            if (next.tagName === "LI") return true;
    
            return false;
        }
    
        let i = 0;
        while (i < children.length) {
            const elem = children[i];
            const next = children[i + 1];
    
            // Si debe agruparse con el siguiente → crear wrapper temporal
            if (shouldGroup(elem, next)) {
                const wrapper = document.createElement("div");
                wrapper.appendChild(elem.cloneNode(true));
    
                while (children[i + 1] && shouldGroup(children[i], children[i + 1])) {
                    i++;
                    wrapper.appendChild(children[i].cloneNode(true));
                }
    
                joined.push(wrapper);
            } else {
                joined.push(elem.cloneNode(true));
            }
    
            i++;
        }
    
        // limpiamos temp y lo reemplazamos
        temp.innerHTML = "";
        joined.forEach(el => temp.appendChild(el));
    
        let slides = [];
        let currentSlide = document.createElement("div");

        container.style.visibility = "hidden"; // ocultar mientras calculamos

        const contentArea = document.querySelector(".slide-content");
        const MAX_HEIGHT = contentArea.clientHeight; //container.clientHeight;

        [...temp.children].forEach(elem => {
            currentSlide.appendChild(elem.cloneNode(true));

            container.innerHTML = "";
            container.appendChild(currentSlide);

            if (container.scrollHeight > MAX_HEIGHT) {
                // quitar el último elemento que causó overflow
                currentSlide.removeChild(currentSlide.lastElementChild);

                slides.push(currentSlide);

                // crear nueva slide
                currentSlide = document.createElement("div");
                currentSlide.appendChild(elem.cloneNode(true));
            }
        });

        // agregar última slide
        slides.push(currentSlide);

        // estado
        let index = 0;
        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");

        function renderSlide() {
            container.innerHTML = slides[index].innerHTML;
            setupInteractividad();
            
            // Actualizar estado botones (opcional, visual)
            // btnPrev.disabled = (index === 0 && !"{{ prev }}");
            btnPrev.disabled = (index === 0);
        }

        renderSlide();
        container.style.visibility = "visible";

        btnPrev.onclick = () => {
            if (index > 0) {
                index--;
                renderSlide();
            } 
            // else if ("{{ prev }}") {
            //     // ir al SCO anterior
            //     finishSCORM();
            //     window.location.href = "{{ prev }}";
            // }
        };

        btnNext.onclick = () => {
            if (index < slides.length - 1) {
                index++;
                renderSlide();
            } else {
                
                // 1. Marcar como completado    
                finishSCORM("completed");

                // 2. Navegación
                if ("{{ next }}") {
                    window.location.href = "{{ next }}";
                } else {
                    // Si no hay siguiente URL, es el final del curso
                    alert("Has finalizado este módulo.");
                    // En algunos LMS conviene cerrar la ventana:
                    // window.close(); 
                }
            }
        };
    });

    // SEGURIDAD: Si el usuario cierra la pestaña a la fuerza, intentamos cerrar conexión
    window.onunload = function() {
        finishSCORM();
    };
</script>

<!-- js original del doc -->
{% if extra_js_not_script %}
<script>
function setupInteractividad() {
    {{ extra_js_not_script | safe }}
};
</script>
{% else %}
<script>
    function setupInteractividad() {
        console.log("No se ha cargado código JS adicional.");
};
</script>
{% endif %}

</body>
</html>
